# 微信小程序学习第11天

## 每日反馈&&作业完成情况

1. 更改/新增地址的功能怎么实现呢
   
   1. 需要后端提供接口
   2. 不能更新/新增微信的通讯地址
2. **登录请求的token写死，不必每次都扫码，思路不错**
   
   1. [传送门](https://gitee.com/xin_yang_yang/mpvue-yougou43/blob/mpyougou_xyy_20200217/src/pages/login/index.vue)
   
   2. 登录请求注释掉
   
   3. ```js
      wx.setStorageSync('token', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjIzLCJpYXQiOjE1ODE1NzkzNDgsImV4cCI6MTAwMTU4MTU3OTM0N30.RTOTD8sOHoIGnzleXmR7MWrmlUn_FlKcxFAVz-JswZ0')
      
      ```
3. 删除已生成订单商品
   
   1. [传送门](https://gitee.com/xin_yang_yang/mpvue-yougou43/blob/mpyougou_xyy_20200217/src/pages/pay/index.vue)
4. 变量声明为vue实例的属性，也就是全局变量了
   
   1. [传送门](https://gitee.com/leishiming/mpvue-yougou/blob/leishiming_20200206/src/pages/pay/index.vue)
5. 手机端无法弹出支付框的bug
   1. **真机调试**
   2. **开发版本小程序删除可以清缓存**



## 优购案例-优化

#### 01.注意购物车页面onShow里面需要对goodsList重置

#### 02.设置购物车的商品个数

1. 购物车的onShow方法里面设置(无论商品是否选中，都算)
2. wx.setTabBarBadge
   1. index
   2. 显示文本，字符串类型
      1. 数量**商品类型个数**

#### 03.request中设置token

1. isAuth为true是添加token
2. 用户有没有登录需要在这里判断

#### 04.request错误提示

	1. status不为200时，提示错误
 	2. fail网络超时

#### 05.立即购买无须清购物车

#### 练习注意点

1. 优购商城支付必须由登录用户支付



## 优购案例-订单结果页

#### 01.页面分析

1. 支付页面，支付取消或者支付成功，都会进入订单结果页

2. 订单结果页支付成功，展示成功状态和首页按钮，点首页按钮去到首页
3. 订单结果页支付失败，展示失败状态和首页按钮与订单详情按钮，点首页按钮去到首页，点订单详情去到订单详情

#### 02.静态页面

1. 文案及两个按钮

#### 03.基本逻辑

1. 支付页面上，支付成功和失败跳转订单结果页
   1. 失败时候传递orderNumber
2. 支付成功显示`首页`,并设置标题
3. 支付失败显示`首页`和`查询订单详情`，也设置标题



## 优购案例-订单详情

#### 01.页面分析

1. 订单结果点订单详情去到订单详情
2. 订单详情展示订单基本信息

#### 02.静态页面

1. 展示订单基本信息

#### 03.请求&渲染数据

1. 未登录跳转登录

2. 查询订单状态

   1. 接口 /api/public/v1/my/orders/chkOrder

      1. 请求方式POST

      2. 请求头:

         "Authorization" : token // 需要设置token带给后台

      3. 请求体:
         order_number : 订单号



## 优购案例-我的

<img src="assets/4-我的--my.PNG" alt="4-我的--my" style="zoom:50%;" />

#### 01.页面分析

1. 入口是tabBar
2. 展示登录状态收藏店铺、订单及其他信息
3. 已经登录展示用户头像和昵称，未登陆就显示登录，点登录跳转登录
4. 点订单跳转订单列表
5. 拨打电话的功能

#### 02.静态页面

#### 03.基本逻辑

1. 已经登录展示用户头像和昵称，未登陆就显示登录，点登录跳转登录
   1. login页userInfo添加到storage
   2. onShow里面获取到用户信息
   3. 点登录跳转登录
2. 拨打电话
   1. wx.makePhoneCall





## 优购案例-订单列表

<img src="assets/6-订单列表--orders.PNG" alt="6-订单列表--orders" style="zoom:50%;" />

#### 01.页面分析

1. 分别展示全部，待付款，已付款，退款/退货的订单列表
2. 在我的页面，点击订单去到订单列表

#### 02.静态页面

1. 顶部tab栏
2. 订单列表展示

#### 03.基本逻辑

1. 我的页面点击不同菜单去到订单列表，选中对应的tab
   1. 两边菜单并不是一一对应的，设置数组序列标志
2. 点击tab展示对应的列表

#### 04.请求&渲染数据

2. 渲染订单列表

   1. 接口`/api/public/v1/my/orders/all?type=1`

      1. 请求方式GET

      2. 请求头:

         "Authorization" : token //需要设置token带给后台

2. 切换Tab发送请求

>在调试器的，AppData里面，红色是数字类型，绿色是字符串。
>





## mpvue与Vuex的结合

vuex就是一个**全局变量**，存储整个所有组件的共享状态。

> 由于全局变量太灵活，vuex定义了一个操作全局变量的规范

核心概念：

1. state 状态
2. Getter是state的计算属性
3. Mutation改变state的方法
   1. 这里就操作全局变量的规范



## mpvue中使用Vuex

1. `vue init mpvue/mpvue-quickstart mpvue-demo-vuex`
2. 安装过程中选择使用vuex
3. pages/counter里面就是vuex的基本使用



## 优购商城整合Vuex

主要思路：

小程序启动时，Vuex中购物车数据从storage里面读取，小程序隐藏时把购物车数据存到storage里面，在这之间购物车的一系列操作，只更改Vuex中购物车数据

1. 在手机上退出小程序会触发onHide钩子函数

#### 准备工作

1. 安装vuex

   ```
   npm install vuex
   ```

2. 新建文件`src/store/index.js`,并创建一个store

3. main.js中$store设置到Vue的原型上

4. 添加Vuex logger插件，方便打印日志

> 内存读取速度比较快，价格贵，断电不会保存
>
> 硬盘容量大，价格便宜，断电后会保存
>
> 读内存不会异步，读硬盘会异步



#### 页面逻辑重构

1. store里面购物车初始化
   1. store里面声明cart，并初始化从storage里面读取
2. 购物车页面
   1. 添加购物车
      1. 添加一个mutations add2Cart
      2. item页面commit
   2. 购物车商品列表展示
      1. store getters获取cart数据
3. App切后台，购物车数据存储到storage
   1. App.vue onHide方法触发
   2. commit storeCart方法
   3. storeCart方法里面存储state.cart到storage