# 微信小程序学习第3天

## 每日反馈



## 回顾



## 自适应单位rpx 

responible

[传送门](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html#%E5%B0%BA%E5%AF%B8%E5%8D%95%E4%BD%8D)

1. 所有设备的宽度都是750rpx。相当于所有设备的宽度750等分，每一份是1rpx

2. 开发微信小程序时设计师用 iPhone6 作为视觉稿的标准，宽度是750px

   1. **代码里面的元素rpx值=设计稿对应元素的像素值**
   2. 设计的宽度就是750px,iphone6的2倍图

3. 需要随屏幕尺寸变化的元素用rpx, 否则用px

   1. 实际项目里面，哪些元素是固定尺寸的，看实际情况

4. 实际开发中，一般只需要用rpx适配好iphone6就行。

5. 哪些css属性需要自适应

   1. margin
   2. padding
   3. border
   4. font-size
   5. width,height



## 异步请求wx.request

[传送门](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)

基本XMLHttpRequest封装的

> 豆瓣API :   https://api.douban.com/v2/movie/in_theaters?apikey=0df993c66c0c636e29ecbb5344252a4a

使用方法基本和$.ajax一样

```js
wx.request({
    url: 'https://api.douban.com/v2/movie/in_theaters',
    method: 'GET',
    data: {
        apikey: '0df993c66c0c636e29ecbb5344252a4a'
    },
    // 看实际情况是否需要写content-type
    header: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
    dataType: 'json',
    success: res => {
        console.log(res)
    }
})
```



看实际情况是否需要写content-type

```js
header: {
  'Content-Type': 'application/x-www-form-urlencoded' // 默认值
}
```



## 设置合法域名

[传送门](https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html)

小程序里面请求的后端服务器，需要在小程序后台注册域名

服务器域名请在 「小程序后台-开发-开发设置-服务器域名」 中进行配置

手机扫码默认也会检查安全域名，...->开发调试->打开调试，就不会检查安全域名了

#### 注意点

1. 微信小程序在开发的时候，可以通过勾选不检验合法域名来解决域名安全的问题，但是上线前一定需要配置合法域名。



## 小程序授权

[授权](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html)

部分接口需要经过用户授权才能调用，比如说获取用户信息、通讯地址、微信运动步数等等

#### 授权行为：

1. 第一次发起授权某权限，会弹窗请求权限，用户同意后会调用接口
2. 如果用户已经授权，直接调用
3. 如果用户已经拒绝，直接进入失败。



#### 基本使用（基本上对于每个授权使用都一样）

1. 先用getSetting获取用户授权的状态，如果拒绝的话，提示打开设置允许

2. 否则的话，使用`wx.authorize`发起授权，就会授权弹窗，再调相应接口获取信息

   ![image-20200106105433640](assets/image-20200106105433640.png)

#### 注意点：

1. 用户信息的授权用`<button open-type="getUserInfo">用户信息</button>`, 即使用户拒绝也会弹出授权。

2. ```js
   <button open-type="getUserInfo" bindgetuserinfo="getuf">用户信息</button>
   ```

3. openSetting打开界面查看到各个授权的状态

4. getSetting也可以得到各个授权状态的数据，程序员使用

5. 在手机微信里面，...点击去到设置里面，可以看到授权状态

6. 学会了基本的授权使用，其他接口随用随查，不需要立马掌握





## 小程序登录

[传送门](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)

第三方登录：第三方网站授权登录

其实就是用微信账号登陆小程序

步骤：

1. 获取用户信息, 如果没有授权过，会在底部弹出授权窗口的

   ```html
   <button open-type="getUserInfo"
               bindgetuserinfo="getuserinfo">点我登录</button>
   ```

2. wx.login()获取到code

3. 调后端接口获取token

   1. /user/wxlogin



## Loading效果

[showLoading](https://developers.weixin.qq.com/miniprogram/dev/api/ui/interaction/wx.showLoading.html)

1. wx.showLoading与wx.hideLoading是显示与隐藏loading提示框
   1. title提示的内容
   2. mask loading中是否能操作mask以下
2. wx.showNavigationBarLoading与wx.hideNavigationBarLoading  在当前页面显示导航条加载动画 



## 蘑菇在线项目演示

1. 登录页 微信授权登陆
2. 手机登录页
3. 首页
4. 

## 项目说明

1. 后面node.js项目地址 https://gitee.com/jovenwang/mushroom-online-server
2. 微信小程序前端完成项地址 https://gitee.com/jovenwang/mp-mushroom-online
   1. 完整项目在分支 master
   2. 静态页面在分支 Fea_static_pages
3. 接口API https://gitee.com/jovenwang/mushroom-online-server/blob/master/api.md
4. 设计稿 https://lanhuapp.com/url/8NzGu-m2LY3



## 项目准备

后台准备

1. 数据库初始化
2. server启动
3. 测试后端接口能够调用
4. 新建微信小程序项目
   1. 项目名`mp-mushroom-online`
   2. 新建login页面，删除多余页面
   3. app.js和app.wxss内容重置



## 登录页

<img src="assets/image-20200221174732603.png" alt="image-20200221174732603" style="zoom:50%;" />

### 01.页面分析

1. 小程序的入口
2. 微信授权登录
3. 手机号码登录跳转到手机登录页面

### 02.静态页面

1. logo展示
2. 文案展示
3. 微信授权按钮展示
4. 手机号码登录和商标展示

### 03.基本逻辑

1. 点击`微信授权登录`按钮，弹出授权窗口，确定后完成登录跳转到首页
   1. 写一个透明button
      1. open-type="getUserInfo"
      2. bindgetuserinfo="wxLogin"
   2. wxLogin获取用户信息，再wx.login获取用户登录凭证，调接口登录
      1. url :/user/wxlogin
      2. 方法 POST
      3. data:{code,nickname,avatar}
   3. 登录成功
      1. 提示微信登录成功
      2. 跳转到首页
   4. 添加loading
2. 点手机号码登录，跳转到手机登录页面
   1. 声明式navigator组件

### 04.优化

 	1. 获取用户信息，弹窗用户拒绝处理，提示`登录失败，请授权`
      	1. 判断是否获取到用户信息





## 数据存储

[传送门](https://developers.weixin.qq.com/miniprogram/dev/api/storage/wx.setStorageSync.html)

1. 浏览器的本地存储

   1. localStorage（关闭浏览器后还存在）
   2. sessionStorage(关闭浏览器后不存在)
   3. 区别，使用，大小限制，存储类型？？？
      1. setItem(key,string),removeItem,getItem,clear
      2. 存储类型只能是字符串
      3. 5M

2. 小程序

   1. wx.setStorage,wx.getStorage....

   #### 01.存数据

   建议用setStorageSync

   本质是存数据是异步的，API上有同步和异步之分

   ```js
   // 异步存储
   wx.setStorage({
      key: 'name',
      data: 'Joven',
     success:function(){
       // 这里存储成功
     }
   })
   // 建议用同步存储
    wx.setStorageSync('age', 28)
   ```

> AJAX的A是Async
>
> fs.readFileSync



#### 02.取数据

建议用getStorageSync

```js
// 异步取数据
wx.getStorage({
  key: 'name',
  success: function(res) {
    console.log(res)
  }
})
// 建议用：同步取数据
console.log(wx.getStorageSync('age'))
```

> getStorageInfo是用来获取storage所有的信息的

#### 03.清除数据

1. clearStorageSync 清除所有数据

2. 删除指定项数据

   ```js
   // 异步删除指定key的数据
   wx.removeStorage({
     key: 'name',
     success: function(res) {
       console.log(res)
     },
   })
   // 同步删除指定key的数据
   wx.removeStorageSync('name')
   ```


#### 04.总结

1. 小程序的storage其实是对手机存储系统的文件读取，所以是异步的

2. 小程序的存储可以是复杂类型，JSON.parse能够解析的

3. 单个 key 允许存储的最大数据长度为 1MB，所有数据存储上限为 10MB 

   >内存，速度快，断电会丢失存储，价格贵，容量偏小
   >
   >硬盘，SSD，速度偏慢，断电不会丢失，价格相对便宜，容量大。

#### 05.存一个复杂类型数据，然后取出来

setStorageSync只是写法上同步，本质存储依然是异步的。（fs.readFileSync）



## 登录页

#### 05.登录成功，存储token

1. setStorageSync
2. key值 token





## image组件的mode属性

 图片裁剪、缩放的模式 ,类似于background-size:cover

​	[传送门](https://developers.weixin.qq.com/miniprogram/dev/component/image.html)

1. 默认是scaleToFill:拉伸
2. aspectFit：保持宽高比，长边显示出来
3. aspectFill:保持宽高比，短边显示，长边截取
4. widthFix:保持宽高比，宽度不变，高度自动变化

如果需要显示的图片和image的宽度和高度比例是一致的话，无论什么模式效果是一样的。



## Tab栏配置

[传送门](https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html#tabBar)

app.json的tabBar属性配置Tab栏，点击不同tab显示对应的页面

使用方法：在app.json里面配置

```js
 "tabBar": {
     // tab未选中时的文字颜色
     "color": "#0000ff",
      // tab选中时的文字颜色
      "selectedColor":"#eb4450",
      "list": [
        {
          // tab选中时显示的页面路径
          "pagePath": "pages/index/index",
          // tab的文案
          "text": "首页"，
            iconPath  ，
            selectedIconPath
            
        }
     }
}
```



## 优购Tab栏-练习

<img src="C:\Users\joven\Desktop\learnmp\day04\01-教学资料\assets\1-首页--index.PNG" alt="1-首页--index" style="zoom:33%;" />

1. 新建四个页面home,category,cart,me
2. copy文档tabBar配置，修改四个tab的文案
3. 设置selectedColor:  tab 上的文字选中时的颜色 
4. 设置iconPath  没选中时图片路径 
5. 设置selectedIconPath 选中时图片路径



## Tab栏切换

1. 只有配置在tabBar中的页面才有tab栏
2. 页面跳转
   1. 跳转到tab页面用`switchTab`
   2. 跳转到非tab页面用`navigateTo`



## 组件Input

[传送门](https://developers.weixin.qq.com/miniprogram/dev/component/input.html)

基本概念：输入框

用法基本和html input标签一样

特点：

1. 默认没有边框
2. type键盘类型
   1. 默认类型是text
   2. number数字键盘
   3. idcard有一个X键
3. confirm-type 键盘右下角按钮的文案
   1. search 搜索

如何获取输入框中的内容

1. 添加input事件 bindinput
2. 事件处理方法里面，**event.detail.value**即是用户的输入
3. 小程序没有v-model

确认事件 bindconfirm

> 微信开发者工具不稳定，无法触发bindinput，只是调试基础库2.9.3