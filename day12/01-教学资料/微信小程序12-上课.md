# 微信小程序学习第3天

## 每日反馈

1. 今天是来黑马学习的第99天，收获颇多。 越来越临近离开黑马找工作的时间，心中不免有些许忐忑。感觉前面学的知识忘掉一些，最近学的知识只吸收了一些，也不知道后面的课程是不是更难一些。 希望老师能多讲讲刚到公司的经历，消除我们的恐惧。
2. 如何锻炼写代码的思路
   1. 不知道思路，是因分析思路还不够细
3. 有什么学习方法(建议)
   1. 抓住重点项目，比如黑马面面，黑马头条，优购商城
   2. 参考笔记思路写一遍，拖开老师的思路写一遍
   3. 搞弄每一个文件是干什么的



## 作业

1. https://github.com/q190776912/yougou/blob/master/src/pages/search/search.vue
   1. 搜索关键字添加到历史搜索列表的逻辑统一到SearchBar组件里
   2. 并且灵活使用了展开运算符
2. https://gitee.com/white_luo/yougou/blob/study/src/pages/search_page/search_page.vue
   1. 基本没问题
3. https://github.com/Mr-chen465/uni-app
   1. 没push?
4. https://gitee.com/guo_miao_tao/uni-yougou45
   1. 访问受限
5. https://gitee.com/yueyue0422/yougou/blob/yueyue0303/pages/search/search.vue
   1. 没啥问题，有详细注释
6. https://gitee.com/hqmin/uni-yougou/blob/dev/src/components/SearchBar.vue
   1. 搜索关键字添加到历史搜索列表的逻辑统一到SearchBar组件里，赞
7. https://gitee.com/blurboy/uni-yougou/blob/Fea_joven_20200302/src/pages/search/search.vue
   1. 有调试痕迹，建议使用debugger

## 回顾

1. 搜索列表
2. 搜索页面
3. 购物车

## 优购案例-购物车

<img src="../../%25E4%25BC%2598%25E8%25B4%25AD/assets/3-%25E8%25B4%25AD%25E7%2589%25A9%25E8%25BD%25A6--cart.PNG" alt="3-购物车--cart" style="zoom:50%;" />





#### 02.静态页面

1. 标题设置
2. 购物车信息头部
3. 购物车信息列表
4. 底部信息
5. **图标显示，iconfont引入**

#### 03.基本功能

1. 商品详情点购物车跳转到购物车页面

   1. 商品详情点击购物车 @click:toCart
   2. 跳转到购物车页面，uni.switchTab

2. 展示购物车商品列表

   1. 数据从哪来？从接口分析，接口只会返回部分数据，另一部分需要storage; 而且接口依赖storage存的购物车

      1. storage购物车的数据结构

         1. 购物车至少得有商品Id,商品的数量,商品有没有被选中的状态
         2. 用对象的形式还是数组的形式呢？
            1. 数组好，因为数组是有序的

         ```js
         //声明成obj,商品id为key，值里面包含num和选中状态两个属性
         cart = {
           商品id: {
             num: 商品数量, 
             checked:true
           }
         }
         
         //数组里面存对象，对象里面包含三个属性
         cart=[
             {
                 商品Id，
                 商品数量，
                 是否选中
             }
         ]
         ```

      2. storage购物车数据添加. 商品详情页面，点击添加购物车，把当前商品存储到storage购物车

         1. 可能我们存之前就有数据。所以思路：取storage购物车，改数据，再存回去
         2. 怎么改数据？无非改商品id，商品数量以及是否选中
            1. 存goodsId没问题
            2. 商品数量
               1. 第一次添加，数量为1
               2. 非首次添加数量++
               3. 如何判断是否是第一次添加呢?
            3. 选中状态
               1. 如果购物车里面用户勾选了商品，商品详情添加购物车，这个商品就是勾选的
               2. 如果购物车里面用户去勾选了商品，商品详情添加购物车，这个商品就是勾选的
               3. 总之，添加商品，总是选中的。
            4. 如果第一次添加，插入到数组最前面; 否则直接更改

      3. 购物车页面根据storage购物车数据发请求 

         1. 尽早地发请求onShow
         2. 取storage购物车数组每个对象的goodsId，拼成字符串
            1. map方法返回数组，然后join成字符串
            2. 调接口发请求，拿数据
            3. 如果购物车数据为空，不必请求

      4. 渲染页面

         1. 如何取storage购物车数组的商品数量或者选中状态？
            1. 太南了
            2. 解决方案：合并数据
               1. forEach结合展开运算符？
               2. map结合展开运算符
         2. 渲染商品名称，图片及价格
         3. 渲染复选框，点击的勾选/去勾选
            1. v-bind:class
         4. 商品数量修改
            1. -按钮最小值为1，1时disabled
            2. +按钮

3. 全选逻辑

   1. 所有商品选中时，触发全选选中状态;有一个商品不选中时，去勾选全选
      1. **every()是对数组中每一项运行给定函数，如果该函数对每一项返回true,则返回true。**
      2. **some()是对数组中每一项运行给定函数，如果该函数有一项返回true，则返回true。**
   2. 选中全选，所有商品选中;去勾选全选，所有商品不选中。
      1. 如果想真正改变计算属性，需要改变计算属性的依赖

   > // 如果所有商品都勾选的话，就true;详解：拿出goodsList.length==勾选商品的个数
   >
   > // 默认true,遍历goodsList，如果有一项没勾选的话，就false
   >
   > forEach不能够break; for of是可以break

4. 总数量和总价格

   1. 总数量显示

      1. reduce的用法

      ```js
      arr.reduce(function(上一次计算后的值，当前遍历中的元素)){
          return 上一次计算后的值与当前遍历中的元素的运算
      }，初始值)
      ```

   2. 总价显示

   3. 注意只有选中的商品才参与计算

5. 页面隐藏时onHide，保存cart状态到storage



## 优购案例-登录

#### 01.页面分析

1. 购物车页面点结算，如果未登录，跳转登录，否则跳转支付页面
2. 登录页上，点立即登录，登录成功，存token, 并goBack

#### 02.基本逻辑

| getUserInfo | 获取用户信息，可以从bindgetuserinfo回调中获取到用户信息 |
| ----------- | ------------------------------------------------------- |
|             |                                                         |

1. 购物车点结算，当然如果没有选择商品就提示;未登录跳转登录; 否则跳转支付页面
   1. 是否登录判断token
2. 登录页，立即登录
   1. getUserInfo+code，调登录接口
   2. 存储token并back

#### 练习注意：

> 1. 微信开发者账号，切换用户，截图让我扫码
> 2. 微信开发者工具appid换掉：wx38d8faffac4d34d2
> 3. baseURL要更新了https://www.uinav.com



## 小程序微信支付

[传送门](https://pay.weixin.qq.com/static/product/product_intro.shtml?name=miniapp)

用户在微信小程序内唤起微信支付，完成支付返回微信小程序

使用示例

![image-20200307231545478](assets/image-20200307231545478.png)

#### 申请流程

1. 申请小程序开发者账号

2. 微信认证

   1.  个人号无法认证

3. 小程序开通微信支付

4. 点击开通按钮后，选择新申请微信支付商户号或绑定一个已有的微信支付商户号，

5. 申请微信支付商户号

   1. [传送门](https://pay.weixin.qq.com/index.php/apply/applyment_home/guide_normal)
   2. 需要营业执照和银行卡号

6. 业务流程

   1. ![image-20200307231623694](assets/image-20200307231623694.png)

7. 后端调用`wxsdk.reqWXUnifiedorder`,传入appid，商户号，open_id等生成前端微信支付的参数。

8. 小程序调用wx.requestPayment，唤起微信支付

   

## 优购案例-支付

#### 01.页面分析

1. 购物车点结算，或者商品详情点立即购买去到支付页面
2. 支付页面展示收货地址选择以及需要确定购买的商品列表（**不能去选中及修改数量, 没有勾选**）
3. 点击微信支付，生成订单，再微信支付
4. 支付成功或者失败进入订单结果页

#### 02.静态页面

1. 新建支付页面pay
2. 收货地址和选择收货地址
3. 收货地址边框
4. 商品列表copy，修改部分
5. 微信支付按钮，及订单信息也 

#### 03.基本逻辑

1. 购物车点结算跳转支付页面

   1. 商品数量不能为0
   2. 必须有token
   3. 满足条件才跳转支付页面

2. 点击请选择地址，选择微信地址，选择地址确定，获取地址，显示地址

   1. 微信，我->头像->我的地址，里面有微信的收货地址，这里同步微信的收货地址
   2. 点击请求选择地址@click="getAddress"
   3. 获取微信收货地址 wx.chooseAddress成功回调里获取

3. 获取到收货地址后，缓存到本地; 页面初始化时从缓存中读取

   

#### 04.请求数据&渲染数

1. 根据商品ids请求商品详情,**渲染购物车选中的商品**，方法getGoodsList

   1. 接口 `/api/public/v1/goods/goodslist?goods_ids=${ids}`
      1. 过滤掉未选中的商品
   2. storage里面未选中的商品过滤掉
   3. 总价格的显示，计算属性

2. 点击微信支付先生成订单

   1. 判断是否有商品，是否选择了地址

   2. 接口/api/public/v1/my/orders/create

      1. method:POST

      2. 请求头 "Authorization" : token

      3. data:{

         order_price 订单价格

         consignee_addr 订单地址

         goods 商品列表内部存放商品对象（goods_id，goods_number和goods_price）}

      4. 不论支付成功或者失败，都从购物车里面清掉选中的商品

         1. Object.delete

3. 生成订单成功后，生成预支付交易单

   1. 接口/api/public/v1/my/orders/req_unifiedorder
      1. method:POST
      2. 请求头 "Authorization" : token
      3. 请求体:
         order_number : 订单号

4. 生成订单后，调用wx.requestPayment

## 总结

## 作业